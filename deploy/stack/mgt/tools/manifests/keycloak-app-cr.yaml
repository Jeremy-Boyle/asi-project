apiVersion: kappctrl.k14s.io/v1alpha1
kind: App
metadata:
  name: #@ "{}-keycloak".format(data.values.cluster_name)
  namespace: #@ data.values.namespace
spec:
  cluster:
    kubeconfigSecretRef:
      name: #@ "{}-kubeconfig".format(data.values.cluster_name)
      key: value
  syncPeriod: 5m
  paused: false
  fetch:
  - helmChart:
      name: keycloak
      repository:
        url: https://charts.bitnami.com/bitnami
      version: "6.1.5"

  template:
  - helmTemplate:
      name: keycloak
      namespace: keycloak
      valuesFrom:
      - secretRef:
          name: #@ "{}-keycloak-helm-values".format(data.values.cluster_name)
  - ytt:
      ignoreUnknownComments: true
      inline:
        paths:
          00-namespace.yaml: |
            #@ load("@ytt:overlay", "overlay")
            ---
            apiVersion: v1
            kind: Namespace
            metadata:
              labels:
                kubernetes.io/metadata.name: keycloak
              name: keycloak
            ---
            apiVersion: cert-manager.io/v1
            kind: Certificate
            metadata:
              name: keycloak-serving-cert
              namespace: keycloak
            spec:
              dnsNames:
              - keycloak.default.svc
              - auth.platform-ops.com
              issuerRef:
                kind: Issuer
                name: keycloak-selfsigned-issuer
              secretName: keycloak-service-cert
            ---
            apiVersion: cert-manager.io/v1
            kind: Issuer
            metadata:
              labels:
                cluster.x-k8s.io/provider: infrastructure-aws
              name: keycloak-selfsigned-issuer
              namespace: keycloak
            spec:
              selfSigned: {}

  deploy:
  - kapp:
      rawOptions:
      - --wait-timeout=5m
      - --diff-changes=true